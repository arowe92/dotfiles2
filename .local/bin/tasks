#!/bin/env python

import sys
import subprocess as sp
import toml
from pathlib import Path

def upfind(filename='tasks.toml'):
    paths = []

    path = Path().absolute()
    if not path.is_dir():
        path = path.parent

    while True:
        paths += list(path.glob(filename))
        if path.parent == path:
            break

        path = path.parent

    return list(reversed(paths))

file_type = sys.argv[1]
config = {}

for file in upfind():
    with open(file) as f:
        config = {
            **config,
            **toml.load(f)
        }

tasks = config.get('tasks', {})

def get_task_list(name):
    ret = []
    task_list = tasks.get(name, {})

    if type(task_list) is list:
        ret = [{"name": "cmd", "cmd": v} for v in task_list]

    if type(task_list) is dict:
        ret = [{"name": k, "cmd": v} for k,v in task_list.items()]

    return ret

task_list = [
    *get_task_list(file_type),
    *get_task_list('all')
]

B='\x1b[33;3m'
E='\x1b[0m'

task_str = ''
for obj in task_list:
    name = obj['name']
    cmd = obj['cmd']
    label= f'{B}{name}:{E} {cmd}'
    task_str += ','.join([cmd, label]) + "\n"
    print(f'{cmd},{label}')
