#!/bin/env python

import sys
import subprocess as sp
import toml
from pathlib import Path

Checkers = {
    'rust': 'Cargo.toml',
    'git': '.git',
}

def upfind(filename='tusk.toml'):
    paths = []

    path = Path().absolute()
    if not path.is_dir():
        path = path.parent

    while True:
        paths += list(path.glob(filename))
        if path.parent == path:
            break

        path = path.parent

    return list(reversed(paths))

filetypes = set()

if len(sys.argv) > 1:
    filetypes.add(sys.argv[1])

config = {}

for file in upfind('.tusk.toml'):
    with open(file) as f:
        config = {
            **config,
            **toml.load(f)
        }

tasks = config.get('tasks', {})

def get_task_list(name):
    ret = {}
    task_list = tasks.get(name, {})

    if type(task_list) is list:
        ret = {v: {"name": "cmd", "cmd": v} for v in task_list}

    if type(task_list) is dict:
        ret = {v: {"name": k, "cmd": v} for k,v in task_list.items()}

    return ret

print(Checkers)
for ft, checker in Checkers.items():
    if len(upfind(checker)) > 0:
        filetypes.add(ft)

task_list = {
    **get_task_list('all')
}

for ft in filetypes:
    task_list = {
        **task_list,
        **get_task_list(ft),
    }


B='\x1b[33;3m'
E='\x1b[0m'

task_str = ''
for obj in task_list.values():
    name = obj['name']
    cmd = obj['cmd']
    label= f'{B}{name}:{E} {cmd}'
    task_str += ','.join([cmd, label]) + "\n"
    print(f'{cmd},{label}')
